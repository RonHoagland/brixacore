{% extends "layouts/app_shell.html" %}

{% block title %}Backup & Restore - BrixaWares{% endblock %}
{% block page_title %}Backup & Restore{% endblock %}

{% block main_content %}
<div style="display: grid; gap: var(--bx-spacing-xl);">

    <!-- Settings Summary -->
    <div class="card" style="background: white; padding: var(--bx-spacing-lg); border-radius: 8px; border: 1px solid var(--bx-color-border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--bx-spacing-md);">
            <h3 style="color: var(--bx-color-primary);">Configuration</h3>
            <!-- Link to preferences if editing is needed -->
        </div>
        <div style="margin-bottom: var(--bx-spacing-md);">
            <div style="font-size: 0.85em; color: var(--bx-color-text-muted);">Backup Path</div>
            <div style="font-weight: 500; word-break: break-all;">{{ settings.backup_path }}</div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--bx-spacing-md);">
            <div>
                <div style="font-size: 0.85em; color: var(--bx-color-text-muted);">Schedule</div>
                <div style="font-weight: 500;">Daily at {{ settings.schedule_time }}</div>
            </div>
            <div>
                <div style="font-size: 0.85em; color: var(--bx-color-text-muted);">Retention</div>
                <div style="font-weight: 500;">Keep last {{ settings.retention_count }}</div>
            </div>
            <div>
                <div style="font-size: 0.85em; color: var(--bx-color-text-muted);">Status</div>
                <div style="font-weight: 500;">
                    {% if settings.is_enabled %}
                    <span style="color: var(--bx-color-success);">Enabled</span>
                    {% else %}
                    <span style="color: var(--bx-color-text-muted);">Disabled</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="card" style="background: white; padding: var(--bx-spacing-lg); border-radius: 8px; border: 1px solid var(--bx-color-border);">
        <h3 style="margin-bottom: var(--bx-spacing-md);">Actions</h3>
        <form method="post" action="{% url 'trigger_backup' %}">
            {% csrf_token %}
            <button type="submit" style="padding: 0.75rem 1.5rem; background-color: var(--bx-color-primary); color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
                Run Manual Backup
            </button>
            <span style="margin-left: var(--bx-spacing-sm); color: var(--bx-color-text-muted); font-size: 0.9em;">
                This may take a few moments.
            </span>
        </form>
    </div>

    <!-- History -->
    <div class="card" style="background: white; padding: var(--bx-spacing-lg); border-radius: 8px; border: 1px solid var(--bx-color-border);">
        <h3 style="margin-bottom: var(--bx-spacing-md);">Backup History</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--bx-color-border); text-align: left;">
                    <th style="padding: var(--bx-spacing-sm);">
                        <a href="?sort=backup_timestamp&dir={% if current_sort == 'backup_timestamp' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            Date
                            {% if current_sort == 'backup_timestamp' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">
                         <a href="?sort=backup_id&dir={% if current_sort == 'backup_id' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            ID
                            {% if current_sort == 'backup_id' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">
                        <a href="?sort=backup_type&dir={% if current_sort == 'backup_type' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            Type
                            {% if current_sort == 'backup_type' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">
                        <a href="?sort=status&dir={% if current_sort == 'status' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            Status
                            {% if current_sort == 'status' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">
                        <a href="?sort=database_size_bytes&dir={% if current_sort == 'database_size_bytes' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            Size
                            {% if current_sort == 'database_size_bytes' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for b in backups %}
                <tr style="border-bottom: 1px solid var(--bx-color-border);">
                    <td style="padding: var(--bx-spacing-sm);">{{ b.backup_timestamp|date:"Y-m-d H:i" }}</td>
                    <td style="padding: var(--bx-spacing-sm);"><code>{{ b.backup_id }}</code></td>
                    <td style="padding: var(--bx-spacing-sm);">{{ b.get_backup_type_display }}</td>
                    <td style="padding: var(--bx-spacing-sm);">
                        {% if b.status == 'success' %}
                        <span style="color: var(--bx-color-success);">Success</span>
                        {% elif b.status == 'failed' %}
                        <span style="color: var(--bx-color-danger);">Failed</span>
                        {% elif b.status == 'in_progress' %}
                        <span style="color: var(--bx-color-info);">Running...</span>
                        {% else %}
                        {{ b.status|title }}
                        {% endif %}
                    </td>
                    <td style="padding: var(--bx-spacing-sm);">
                        {% if b.database_size_bytes %}
                        {{ b.database_size_bytes|filesizeformat }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: var(--bx-spacing-lg); text-align: center; color: var(--bx-color-text-muted);">
                        No backups found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}
