{% extends "layouts/app_shell.html" %}

{% block title %}Backup & Restore - BrixaWares{% endblock %}
{% block page_title %}Backup & Restore{% endblock %}

{% block main_content %}
<div style="display: grid; gap: var(--bx-spacing-xl);">

    <!-- Settings Summary -->
    <!-- Settings Summary -->
    <div class="card" style="background: white; padding: var(--bx-spacing-lg); border-radius: 8px; border: 1px solid var(--bx-color-border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--bx-spacing-md);">
            <h3 style="color: var(--bx-color-primary);">Configuration</h3>
        </div>
        
        <!-- Backup Path (Read Only) -->
        <div style="margin-bottom: var(--bx-spacing-md);">
            <div style="font-size: 0.85em; color: var(--bx-color-text-muted);">Backup Path (Read-only)</div>
            <div style="font-weight: 500; word-break: break-all; color: var(--bx-color-text-light);">{{ settings.backup_path }}</div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--bx-spacing-md);">
            
            <!-- Schedule -->
            <div class="setting-item">
                <div style="font-size: 0.85em; color: var(--bx-color-text-muted);">Schedule</div>
                
                <div id="view-schedule" style="display: flex; align-items: center; gap: 8px;">
                    <div style="font-weight: 500;">Daily at {{ settings.schedule_time }}</div>
                    <button onclick="toggleEdit('schedule')" style="background: none; border: none; cursor: pointer; color: var(--bx-color-primary); font-size: 0.9em;">✎</button>
                </div>
                
                <form id="edit-schedule" action="{% url 'update_backup_settings' %}" method="POST" style="display: none; margin-top: 4px;">
                    {% csrf_token %}
                    <input type="time" name="schedule_time" value="{{ settings.schedule_time|time:'H:i' }}" style="padding: 4px; border: 1px solid var(--bx-color-border); border-radius: 4px;">
                    <button type="submit" style="padding: 4px 8px; background: var(--bx-color-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    <button type="button" onclick="toggleEdit('schedule')" style="padding: 4px 8px; background: transparent; color: var(--bx-color-text-muted); border: none; cursor: pointer;">✕</button>
                </form>
            </div>

            <!-- Retention -->
            <div class="setting-item">
                <div style="font-size: 0.85em; color: var(--bx-color-text-muted);">Retention</div>
                
                <div id="view-retention" style="display: flex; align-items: center; gap: 8px;">
                    <div style="font-weight: 500;">Keep last {{ settings.retention_count }}</div>
                    <button onclick="toggleEdit('retention')" style="background: none; border: none; cursor: pointer; color: var(--bx-color-primary); font-size: 0.9em;">✎</button>
                </div>

                <form id="edit-retention" action="{% url 'update_backup_settings' %}" method="POST" style="display: none; margin-top: 4px;">
                    {% csrf_token %}
                    <input type="number" name="retention_count" value="{{ settings.retention_count }}" min="5" style="width: 60px; padding: 4px; border: 1px solid var(--bx-color-border); border-radius: 4px;">
                    <button type="submit" style="padding: 4px 8px; background: var(--bx-color-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    <button type="button" onclick="toggleEdit('retention')" style="padding: 4px 8px; background: transparent; color: var(--bx-color-text-muted); border: none; cursor: pointer;">✕</button>
                </form>
            </div>

            <!-- Status -->
            <div class="setting-item">
                <div style="font-size: 0.85em; color: var(--bx-color-text-muted);">Status</div>
                
                <div id="view-status" style="display: flex; align-items: center; gap: 8px;">
                    <div style="font-weight: 500;">
                        {% if settings.is_enabled %}
                        <span style="color: var(--bx-color-success);">Enabled</span>
                        {% else %}
                        <span style="color: var(--bx-color-text-muted);">Disabled</span>
                        {% endif %}
                    </div>
                    <button onclick="toggleEdit('status')" style="background: none; border: none; cursor: pointer; color: var(--bx-color-primary); font-size: 0.9em;">✎</button>
                </div>

                <form id="edit-status" action="{% url 'update_backup_settings' %}" method="POST" style="display: none; margin-top: 4px; align-items: center; gap: 8px;">
                    {% csrf_token %}
                    <select name="is_enabled" style="padding: 4px; border: 1px solid var(--bx-color-border); border-radius: 4px;">
                        <option value="true" {% if settings.is_enabled %}selected{% endif %}>Enabled</option>
                        <option value="false" {% if not settings.is_enabled %}selected{% endif %}>Disabled</option>
                    </select>
                    <button type="submit" style="padding: 4px 8px; background: var(--bx-color-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    <button type="button" onclick="toggleEdit('status')" style="padding: 4px 8px; background: transparent; color: var(--bx-color-text-muted); border: none; cursor: pointer;">✕</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function toggleEdit(field) {
            const viewEl = document.getElementById('view-' + field);
            const editEl = document.getElementById('edit-' + field);
            
            if (viewEl.style.display === 'none') {
                viewEl.style.display = 'flex';
                editEl.style.display = 'none';
            } else {
                viewEl.style.display = 'none';
                editEl.style.display = 'flex';
            }
        }
    </script>

    <!-- Actions -->
    <div class="card" style="background: white; padding: var(--bx-spacing-lg); border-radius: 8px; border: 1px solid var(--bx-color-border);">
        <h3 style="margin-bottom: var(--bx-spacing-md);">Actions</h3>
        <form method="post" action="{% url 'trigger_backup' %}">
            {% csrf_token %}
            <button type="submit" style="padding: 0.75rem 1.5rem; background-color: var(--bx-color-primary); color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
                Run Manual Backup
            </button>
            <span style="margin-left: var(--bx-spacing-sm); color: var(--bx-color-text-muted); font-size: 0.9em;">
                This may take a few moments.
            </span>
        </form>
    </div>

    <!-- History -->
    <div class="card" style="background: white; padding: var(--bx-spacing-lg); border-radius: 8px; border: 1px solid var(--bx-color-border);">
        <h3 style="margin-bottom: var(--bx-spacing-md);">Backup History</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--bx-color-border); text-align: left;">
                    <th style="padding: var(--bx-spacing-sm);">
                        <a href="?sort=backup_timestamp&dir={% if current_sort == 'backup_timestamp' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            Date
                            {% if current_sort == 'backup_timestamp' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">
                         <a href="?sort=backup_id&dir={% if current_sort == 'backup_id' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            ID
                            {% if current_sort == 'backup_id' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">
                        <a href="?sort=backup_type&dir={% if current_sort == 'backup_type' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            Type
                            {% if current_sort == 'backup_type' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">
                        <a href="?sort=status&dir={% if current_sort == 'status' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            Status
                            {% if current_sort == 'status' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">
                        <a href="?sort=database_size_bytes&dir={% if current_sort == 'database_size_bytes' and current_dir == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
                            Size
                            {% if current_sort == 'database_size_bytes' %}{{ current_dir|yesno:"↓,↑" }}{% endif %}
                        </a>
                    </th>
                    <th style="padding: var(--bx-spacing-sm);">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for b in backups %}
                <tr style="border-bottom: 1px solid var(--bx-color-border);">
                    <td style="padding: var(--bx-spacing-sm);">{{ b.backup_timestamp|date:"Y-m-d H:i" }}</td>
                    <td style="padding: var(--bx-spacing-sm);"><code>{{ b.backup_id }}</code></td>
                    <td style="padding: var(--bx-spacing-sm);">{{ b.get_backup_type_display }}</td>
                    <td style="padding: var(--bx-spacing-sm);">
                        {% if b.status == 'success' %}
                        <span style="color: var(--bx-color-success);">Success</span>
                        {% elif b.status == 'failed' %}
                        <span style="color: var(--bx-color-danger);">Failed</span>
                        {% elif b.status == 'in_progress' %}
                        <span style="color: var(--bx-color-info);">Running...</span>
                        {% else %}
                        {{ b.status|title }}
                        {% endif %}
                    </td>
                    <td style="padding: var(--bx-spacing-sm);">
                        {% if b.database_size_bytes %}
                        {{ b.database_size_bytes|filesizeformat }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="padding: var(--bx-spacing-sm);">
                        {% if b.status == 'success' %}
                        <form action="{% url 'restore_backup' b.backup_id %}" method="post" style="display: inline;" onsubmit="return confirm('WARNING: This will replace your current database with this backup. This cannot be undone. Are you sure?');">
                            {% csrf_token %}
                            <button type="submit" style="padding: 4px 12px; font-size: 0.85em; background-color: var(--bx-color-warning); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Restore</button>
                        </form>
                        {% endif %}
                        
                        <form action="{% url 'delete_backup' b.backup_id %}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this backup? This cannot be undone.');">
                            {% csrf_token %}
                            <button type="submit" style="padding: 4px 12px; font-size: 0.85em; background-color: var(--bx-color-danger); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Delete</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: var(--bx-spacing-lg); text-align: center; color: var(--bx-color-text-muted);">
                        No backups found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}
